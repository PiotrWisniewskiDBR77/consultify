---
description: Rules for working with Assessment Module code
globs:
  - "**/assessment/**"
  - "**/assessment*.ts"
  - "**/assessment*.tsx"
  - "**/assessment*.js"
  - "**/AssessmentWorkflow*"
  - "**/AxisComments*"
  - "**/DRD*"
  - "**/maturity*"
  - "**/rapidlean*"
  - "**/RapidLean*"
  - "**/aiAssessment*"
alwaysApply: false
---

# Assessment Module Development Rules

## Overview

This module implements the **Digital Readiness Diagnosis (DRD)** and other assessment methodologies for ANTYGRACITY Consultify. Follow these rules when working with assessment-related code.

## Module Statistics (v2.0)

- **31 Components** in `components/assessment/`
- **12+ Backend Services** in `server/services/`
- **48+ API Endpoints** across 9 route files
- **3 React Hooks** for assessment operations
- **26 AI Functions** for intelligent assistance

## DRD Axis IDs

Always use these exact axis IDs:

```typescript
type DRDAxis = 
  | 'processes'       // Digital Processes
  | 'digitalProducts' // Digital Products
  | 'businessModels'  // Business Models
  | 'dataManagement'  // Data Management
  | 'culture'         // Culture
  | 'cybersecurity'   // Cybersecurity
  | 'aiMaturity';     // AI Maturity
```

## Workflow States

Use the `WORKFLOW_STATES` enum from `assessmentWorkflowService.js`:

```typescript
type WorkflowState = 
  | 'DRAFT'              // Editable by owner
  | 'IN_REVIEW'          // Stakeholder review phase
  | 'AWAITING_APPROVAL'  // All reviews done
  | 'APPROVED'           // Final approved
  | 'REJECTED'           // Needs revision
  | 'ARCHIVED';          // Historical version
```

## Score Scale

All axis scores must be integers from 1-7:

```typescript
const validateScore = (score: number): boolean => {
  return Number.isInteger(score) && score >= 1 && score <= 7;
};
```

## Required Fields

Every axis assessment MUST include:

1. `actual` (1-7) - current maturity level
2. `target` (1-7) - target maturity level
3. `justification` (min 100 chars) - reasoning for the score

## React Hooks

Use the provided hooks for assessment operations:

```typescript
// Workflow management
import { useAssessmentWorkflow } from '../hooks/useAssessmentWorkflow';
const { workflowStatus, submitForReview, approve, reject } = useAssessmentWorkflow(assessmentId);

// AI assistance
import { useAssessmentAI } from '../hooks/useAssessmentAI';
const { suggestJustification, generateGapAnalysis } = useAssessmentAI(projectId, axisId);

// Real-time collaboration
import { useAssessmentCollaboration } from '../hooks/useAssessmentCollaboration';
const { activeUsers, broadcastActivity } = useAssessmentCollaboration(assessmentId);
```

## API Endpoints Pattern

Follow these patterns:

```
# Assessment data
/api/assessment/:projectId

# AI endpoints
/api/assessment/:projectId/ai/[action]

# Workflow endpoints
/api/assessment-workflow/:assessmentId/[action]
```

## Key Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/assessment/:projectId` | GET/PUT | Assessment data |
| `/api/assessment/:projectId/ai/suggest-justification` | POST | AI suggestion |
| `/api/assessment/:projectId/ai/gap/:axisId` | POST | Gap analysis |
| `/api/assessment-workflow/:id/submit-for-review` | POST | Submit for review |
| `/api/assessment-workflow/:id/approve` | POST | Approve assessment |
| `/api/assessment-workflow/:id/versions` | GET | Version history |

## RBAC Middleware

Always use `assessmentRBAC` middleware on protected routes:

```javascript
router.post('/:id/approve', authMiddleware, assessmentRBAC('update'), async (req, res) => {
  // ...
});
```

Permissions: `'create'`, `'read'`, `'update'`, `'delete'`, `'export'`

## Backend Services

### Core Services

| Service | Purpose |
|---------|---------|
| `assessmentService.js` | Core assessment CRUD |
| `assessmentWorkflowService.js` | Workflow state management |
| `assessmentReportService.js` | PDF/Excel export |

### AI Services

| Service | Purpose |
|---------|---------|
| `aiAssessmentPartnerService.js` | Main AI assistant (16 methods) |
| `aiAssessmentFormHelper.js` | Form validation & suggestions (6 methods) |
| `aiAssessmentReportGenerator.js` | AI report generation (4 methods) |

## Frontend Components

### Key Components

| Component | Purpose |
|-----------|---------|
| `AssessmentAxisWorkspace` | Main axis assessment UI |
| `AssessmentWorkflowPanel` | Workflow status display |
| `AIAssessmentSidebar` | AI assistant sidebar |
| `AssessmentVersionHistory` | Version history viewer |
| `ReviewerDashboard` | Reviewer pending items |
| `MyAssessmentsList` | User's assessments list |

### AppView Values

```typescript
// Assessment views
AppView.ASSESSMENT_DRD
AppView.ASSESSMENT_LEAN
AppView.MY_ASSESSMENTS
AppView.REVIEWER_DASHBOARD
AppView.FULL_STEP1_ASSESSMENT

// Axis views
AppView.FULL_STEP1_PROCESSES
AppView.FULL_STEP1_DIGITAL
// ... etc
```

## AI Integration

Use `aiAssessmentPartnerService.js` methods:

```javascript
// Form assistance
suggestJustification(axisId, score, context)
suggestEvidence(axisId, score, context)
suggestTargetScore(axisId, currentScore, ambitionLevel)

// Validation
validateScoreConsistency(assessment, organizationContext)

// Analysis
generateGapAnalysis(axisId, currentScore, targetScore, justification)
generateProactiveInsights(assessment, organizationContext)

// Reports
generateExecutiveSummary(assessment, options)
generateStakeholderView(assessment, stakeholderRole)
```

## Audit Logging

Log all significant actions:

```javascript
await AssessmentAuditLogger.log({
  userId: req.user.id,
  organizationId: req.user.organizationId,
  action: 'ASSESSMENT_APPROVED',
  resourceType: 'ASSESSMENT',
  resourceId: assessmentId,
  details: { notes },
  ipAddress: req.ip,
  userAgent: req.get('user-agent')
});
```

## Versioning Rules

- Every `submitForReview` creates a new version
- Versions are immutable snapshots
- `restoreVersion` creates a NEW version (non-destructive)

## Database Tables

Key tables:

| Table | Purpose |
|-------|---------|
| `assessments` | Core assessment data |
| `assessment_workflows` | Workflow state |
| `assessment_reviews` | Stakeholder reviews |
| `assessment_versions` | Version history |
| `assessment_comments` | Axis comments |
| `ai_sessions` | AI conversation context |

## Error Handling

Return consistent error responses:

```javascript
res.status(400).json({ error: 'Assessment must be in DRAFT status' }); // Validation
res.status(404).json({ error: 'Assessment not found' });               // Not found
res.status(403).json({ error: 'Insufficient permissions' });           // Permission
res.status(500).json({ error: 'Internal server error' });              // Server error
```

## Testing Checklist

Before submitting code:

- [ ] All workflow state transitions tested
- [ ] RBAC permissions verified
- [ ] Audit logging implemented
- [ ] TypeScript types correct
- [ ] API response format consistent
- [ ] Error handling complete
- [ ] Hook state management correct
- [ ] AI fallbacks working

## Initiative Generator

The Initiative Generator transforms assessment gaps into actionable initiatives:

### Hook

```typescript
const { gaps, generatedInitiatives, generateWithAI, approveAndTransfer } = useInitiativeGenerator(assessmentId);
```

### Key Components

- `InitiativeGeneratorWizard` - Multi-step wizard
- `GeneratedInitiativeCard` - Initiative display
- `InitiativeEditor` - Edit modal

### API Endpoints

- `POST /api/initiatives/generate/:assessmentId` - Generate from assessment
- `POST /api/initiatives/approve` - Transfer to Module 3

See `.cursor/INITIATIVE_GENERATOR.md` for full documentation.

---

## Initiative Lifecycle (Cross-Module)

Initiatives follow a lifecycle that spans multiple modules:

### Status Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  Module 2: Assessment                                                       │
│  ┌─────────┐                                                                │
│  │  DRAFT  │ ──────────────────────────────────────────────────────────┐   │
│  └─────────┘                                                            │   │
└─────────────────────────────────────────────────────────────────────────│───┘
                                                                          │
                                                                          ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Module 3: Initiative Management                                            │
│  ┌──────────┐    ┌────────┐    ┌──────────┐                                │
│  │ PLANNING │───▶│ REVIEW │───▶│ APPROVED │ ────────────────────────┐      │
│  └──────────┘    └────────┘    └──────────┘                         │      │
│       ▲              │                                               │      │
│       └──────────────┘ (revision required)                          │      │
└─────────────────────────────────────────────────────────────────────│──────┘
                                                                       │
                                                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Module 4/5: Execution                                                      │
│  ┌───────────┐    ┌─────────┐    ┌──────┐                                  │
│  │ EXECUTING │◀──▶│ BLOCKED │───▶│ DONE │ ──▶ ARCHIVED                     │
│  └───────────┘    └─────────┘    └──────┘                                  │
│       │                                                                     │
│       └──▶ CANCELLED ──▶ ARCHIVED                                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Status Definitions

| Status | Module | Description |
|--------|--------|-------------|
| `DRAFT` | Assessment (2) | Initial creation from gap analysis |
| `PLANNING` | Initiative Mgmt (3) | Charter development in progress |
| `REVIEW` | Initiative Mgmt (3) | Pending approval reviews |
| `APPROVED` | Initiative Mgmt (3) | Ready for execution |
| `EXECUTING` | Execution (4/5) | Active work in progress |
| `BLOCKED` | Execution (4/5) | Temporarily blocked (requires reason) |
| `DONE` | Terminal | Successfully completed |
| `CANCELLED` | Terminal | Terminated before completion |
| `ARCHIVED` | Terminal | Historical record |

### Key Module Transitions

1. **DRAFT → PLANNING**: Initiative transfers from Assessment to Initiative Management
2. **APPROVED → EXECUTING**: Initiative transfers to Execution module

### Progress Calculation

Initiative progress is calculated as weighted percentage of closed tasks:
- Default: Each task has weight = 1
- Custom: Task weights 1-5x configurable in Task Detail Modal (Execution tab)
- Formula: `(Σ completed_task_weight) / (Σ total_task_weight) * 100`

### Task Types (Supported)

```typescript
type TaskType = 'ANALYSIS' | 'DESIGN' | 'BUILD' | 'PILOT' | 'VALIDATION' | 'DECISION' | 'CHANGE_MGMT';
```

### Evidence Standards

Task completion requires:
1. Person declaration/sign-off (Evidence tab in Task Detail Modal)
2. Sign-off records: who signed, when, revocable
3. Optional acceptance criteria checklist

### Initiative Charter Tabs (Complete)

```typescript
const INITIATIVE_TABS = [
  'overview',      // Executive summary, problem, target state
  'tasks',         // Task list with bulk actions
  'definition',    // Scope in/out, deliverables, success criteria
  'execution',     // Timeline, risks, kill criteria
  'economics',     // CAPEX, OPEX, ROI, benefits
  'governance',    // Roles, workflow timeline, audit trail
  'team',          // Resource allocation, related initiatives
  'comments',      // Discussion thread
  'history',       // Version snapshots, export, clone
  'intelligence'   // AI insights, strategic fit
];
```

### Collaboration Features

- **Comments**: Threaded discussion per initiative
- **Team Members**: Assign with role (Contributor, Reviewer, SME, Stakeholder, Observer) and % allocation
- **Related Initiatives**: Link with relationship types (DEPENDS_ON, BLOCKS, RELATED_TO, PARENT_OF, CHILD_OF)
- **Version History**: Manual snapshots, change tracking by type (STATUS_CHANGE, CONTENT_UPDATE, APPROVAL)
- **Export**: Charter export to JSON (PDF planned)
- **Clone**: Duplicate initiative as template

### Readiness Score (v2)

Charter readiness is calculated across 7 categories:
- **Strategic (15pts)**: Name, Intent, Axis, One-liner
- **Problem (15pts)**: Symptom, Root cause, Cost of inaction, Stakeholders
- **Target (15pts)**: Process, Behavior, Capability changes
- **Execution (15pts)**: Kill criteria, Risks, Deliverables
- **Value (15pts)**: Business value, CAPEX, ROI
- **Governance (15pts)**: Business Owner, Execution Owner, Sponsor
- **Timeline (10pts)**: Start, End dates, Milestones

Threshold: 80% = Ready for Review

---

## Related Documentation

- `.cursor/ASSESSMENT_MODULE_COMPLETE.md` - Full module documentation
- `.cursor/ASSESSMENT_MODULE_WORKFLOW.md` - Workflow documentation
- `.cursor/AI_ASSESSMENT_SYSTEM.md` - AI system documentation
- `.cursor/INITIATIVE_GENERATOR.md` - Initiative Generator documentation
- `.cursor/rules/ai-assessment.mdc` - AI-specific rules
- `.cursor/BACKLOG.md` - Future features and settings backlog
