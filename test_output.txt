
[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify[39m

[90mstdout[2m | tests/unit/backend/aiAuditLogger.test.js
[22m[39m[Database] Selected: SQLite
DEBUG: db in aiAuditLogger is: {
  "initPromise": {}
}

[90mstdout[2m | tests/unit/backend/aiAuditLogger.test.js
[22m[39m[DB:fxgp5l] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/aiAuditLogger.test.js[2m > [22m[2mAIAuditLogger[2m > [22m[2mlogInteraction[2m > [22m[2mshould handle optional fields
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/aiAuditLogger.test.js[2m > [22m[2mAIAuditLogger[2m > [22m[2mlogInteraction[2m > [22m[2mshould handle optional fields
[22m[39mDatabase initialization complete.

 [31mâ¯[39m tests/unit/backend/aiAuditLogger.test.js [2m([22m[2m24 tests[22m[2m | [22m[31m22 failed[39m[2m)[22m[32m 66[2mms[22m[39m
[31m       [31mÃ—[31m should log a basic AI interaction[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should store correlation_id if provided[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should handle optional fields[39m[32m 56[2mms[22m[39m
[31m       [31mÃ—[31m should store explanation data if provided[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should handle database error[39m[32m 3[2mms[22m[39m
[31m       [31mÃ—[31m should log interaction with full explanation object[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should default actionType to AI_RESPONSE[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should log AI suggestion[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should handle minimal parameters[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should update user decision on logged suggestion[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should record rejection without feedback[39m[32m 0[2mms[22m[39m
       [32mâœ“[39m should handle non-existent audit entry[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return audit logs for organization[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should filter by project if provided[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should filter by date range[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should limit results[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should filter by action type[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array on database error[39m[32m 1[2mms[22m[39m
       [32mâœ“[39m should return statistics for organization[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should filter by project if provided[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return role distribution[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should clear logs older than specified days[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should use default retention period of 90 days[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should respect custom retention period[39m[32m 0[2mms[22m[39m

[31mâ¯â¯â¯â¯â¯â¯[39m[1m[41m Failed Tests 22 [49m[22m[31mâ¯â¯â¯â¯â¯â¯â¯[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogInteraction[2m > [22mshould log a basic AI interaction
[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogInteraction[2m > [22mshould store correlation_id if provided
[31m[1mError[22m: SQLITE_ERROR: no such table: ai_audit_logs[39m
[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[1/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogInteraction[2m > [22mshould handle optional fields
[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogInteraction[2m > [22mshould store explanation data if provided
[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogWithExplanation[2m > [22mshould log interaction with full explanation object
[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogWithExplanation[2m > [22mshould default actionType to AI_RESPONSE
[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogSuggestion[2m > [22mshould log AI suggestion
[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogSuggestion[2m > [22mshould handle minimal parameters
[31m[1mError[22m: SQLITE_ERROR: table ai_audit_logs has no column named regulatory_mode[39m
[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[2/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mlogInteraction[2m > [22mshould handle database error
[31m[1mAssertionError[22m: expected [Function] to throw error including 'Database write failed' but got 'SQLITE_ERROR: table ai_audit_logs hasâ€¦'[39m

Expected: [32m"Database write failed"[39m
Received: [31m"SQLITE_ERROR: table ai_audit_logs has no column named regulatory_mode"[39m

[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m137:13[22m[39m
    [90m135| [39m            }[33m;[39m
    [90m136| [39m
    [90m137| [39m            await expect(AIAuditLogger.logInteraction(entry)).rejects.â€¦
    [90m   | [39m            [31m^[39m
    [90m138| [39m        })[33m;[39m
    [90m139| [39m    })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[3/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mrecordUserDecision[2m > [22mshould update user decision on logged suggestion
[31m[1mAssertionError[22m: expected undefined to be true // Object.is equality[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m212:36[22m[39m
    [90m210| [39m            )[33m;[39m
    [90m211| [39m
    [90m212| [39m            [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m213| [39m            [34mexpect[39m(mockDb[33m.[39mrun)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m214| [39m        })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[4/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mrecordUserDecision[2m > [22mshould record rejection without feedback
[31m[1mAssertionError[22m: expected undefined to be true // Object.is equality[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m222:36[22m[39m
    [90m220| [39m            )[33m;[39m
    [90m221| [39m
    [90m222| [39m            [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m223| [39m        })[33m;[39m
    [90m224| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[5/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mgetAuditLogs[2m > [22mshould return audit logs for organization
[31m[1mAssertionError[22m: expected [] to have a length of 2 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 2[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m264:28[22m[39m
    [90m262| [39m            [35mconst[39m result [33m=[39m [35mawait[39m [33mAIAuditLogger[39m[33m.[39m[34mgetAuditLogs[39m([32m'org-1'[39m)[33m;[39m
    [90m263| [39m
    [90m264| [39m            [34mexpect[39m(result)[33m.[39m[34mtoHaveLength[39m([34m2[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m265| [39m            [34mexpect[39m(result[[34m0[39m][33m.[39mid)[33m.[39m[34mtoBe[39m([32m'audit-1'[39m)[33m;[39m
    [90m266| [39m        })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[6/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mgetAuditLogs[2m > [22mshould filter by project if provided
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m272:28[22m[39m
    [90m270| [39m
    [90m271| [39m            [35mconst[39m callArgs [33m=[39m mockDb[33m.[39mall[33m.[39mmock[33m.[39mcalls[[34m0[39m][33m;[39m
    [90m272| [39m            [34mexpect[39m(callArgs[[34m0[39m])[33m.[39m[34mtoContain[39m([32m'project_id'[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m273| [39m        })[33m;[39m
    [90m274| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[7/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mgetAuditLogs[2m > [22mshould filter by date range
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m282:28[22m[39m
    [90m280| [39m
    [90m281| [39m            [35mconst[39m callArgs [33m=[39m mockDb[33m.[39mall[33m.[39mmock[33m.[39mcalls[[34m0[39m][33m;[39m
    [90m282| [39m            [34mexpect[39m(callArgs[[34m0[39m])[33m.[39m[34mtoContain[39m([32m'created_at'[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m283| [39m        })[33m;[39m
    [90m284| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[8/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mgetAuditLogs[2m > [22mshould limit results
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m289:28[22m[39m
    [90m287| [39m
    [90m288| [39m            [35mconst[39m callArgs [33m=[39m mockDb[33m.[39mall[33m.[39mmock[33m.[39mcalls[[34m0[39m][33m;[39m
    [90m289| [39m            [34mexpect[39m(callArgs[[34m0[39m])[33m.[39m[34mtoContain[39m([32m'LIMIT'[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m290| [39m        })[33m;[39m
    [90m291| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[9/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mgetAuditLogs[2m > [22mshould filter by action type
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m296:28[22m[39m
    [90m294| [39m
    [90m295| [39m            [35mconst[39m callArgs [33m=[39m mockDb[33m.[39mall[33m.[39mmock[33m.[39mcalls[[34m0[39m][33m;[39m
    [90m296| [39m            [34mexpect[39m(callArgs[[34m0[39m])[33m.[39m[34mtoContain[39m([32m'action_type'[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m297| [39m        })[33m;[39m
    [90m298| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[10/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mgetAuditLogs[2m > [22mshould return empty array on database error
[31m[1mAssertionError[22m: promise resolved "[]" instead of rejecting[39m

[32m- Expected:[39m 
Error {
  "message": "rejected promise",
}

[31m+ Received:[39m 
[]

[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m307:62[22m[39m
    [90m305| [39m            })[33m;[39m
    [90m306| [39m
    [90m307| [39m            await expect(AIAuditLogger.getAuditLogs('org-1')).rejects.â€¦
    [90m   | [39m                                                             [31m^[39m
    [90m308| [39m        })[33m;[39m
    [90m309| [39m    })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[11/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mgetAuditStats[2m > [22mshould filter by project if provided
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '1')[39m
[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m334:28[22m[39m
    [90m332| [39m
    [90m333| [39m            [35mconst[39m callArgs [33m=[39m mockDb[33m.[39mall[33m.[39mmock[33m.[39mcalls[[34m0[39m][33m;[39m
    [90m334| [39m            [34mexpect[39m(callArgs[[34m1[39m])[33m.[39m[34mtoContain[39m([32m'proj-1'[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m335| [39m        })[33m;[39m
    [90m336| [39m    })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[12/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mgetRoleDistribution[2m > [22mshould return role distribution
[31m[1mAssertionError[22m: expected [] to have a length of 3 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 3[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m353:28[22m[39m
    [90m351| [39m            const result = await AIAuditLogger.getRoleDistribution('orâ€¦
    [90m352| [39m
    [90m353| [39m            [34mexpect[39m(result)[33m.[39m[34mtoHaveLength[39m([34m3[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m354| [39m            [34mexpect[39m(result[[34m0[39m][33m.[39mai_role)[33m.[39m[34mtoBe[39m([32m'CONSULTANT'[39m)[33m;[39m
    [90m355| [39m        })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[13/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mclearOldLogs[2m > [22mshould clear logs older than specified days
[31m[1mAssertionError[22m: expected +0 to be 50 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 50[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m369:36[22m[39m
    [90m367| [39m            const result = await AIAuditLogger.clearOldLogs('org-1', 9â€¦
    [90m368| [39m
    [90m369| [39m            [34mexpect[39m(result[33m.[39mdeleted)[33m.[39m[34mtoBe[39m([34m50[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m370| [39m            [34mexpect[39m(mockDb[33m.[39mrun)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m371| [39m        })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[14/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mclearOldLogs[2m > [22mshould use default retention period of 90 days
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m377:32[22m[39m
    [90m375| [39m
    [90m376| [39m            [90m// Check that the SQL contains the retention period logic[39m
    [90m377| [39m            [34mexpect[39m(mockDb[33m.[39mrun)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m378| [39m        })[33m;[39m
    [90m379| [39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[15/22]â¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiAuditLogger.test.js[2m > [22mAIAuditLogger[2m > [22mclearOldLogs[2m > [22mshould respect custom retention period
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/backend/aiAuditLogger.test.js:[2m383:32[22m[39m
    [90m381| [39m            [35mawait[39m [33mAIAuditLogger[39m[33m.[39m[34mclearOldLogs[39m([32m'org-1'[39m[33m,[39m [34m30[39m)[33m;[39m
    [90m382| [39m
    [90m383| [39m            [34mexpect[39m(mockDb[33m.[39mrun)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m384| [39m        })[33m;[39m
    [90m385| [39m    })[33m;[39m

[31m[2mâ¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯â¯[16/22]â¯[22m[39m


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m22 failed[39m[22m[2m | [22m[1m[32m2 passed[39m[22m[90m (24)[39m
[2m   Start at [22m 00:06:33
[2m   Duration [22m 376ms[2m (transform 27ms, setup 34ms, import 26ms, tests 66ms, environment 171ms)[22m

JUNIT report written to /Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/junit.xml
