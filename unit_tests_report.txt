
> consultify@0.0.1 test:unit
> vitest run tests/unit


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify[39m

[90mstdout[2m | tests/unit/backend/middleware/auditLog.test.js[2m > [22m[2mAuditLog Middleware[2m > [22m[2mshould call next() and override res.end
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/feedbackService.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/middleware/quotaMiddleware.test.js[2m > [22m[2mQuota Middleware (Integration)
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/activityService.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/tokenBillingService.test.js[2m > [22m[2mTokenBillingService - Integration
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/middleware/projectQuotaMiddleware.test.js[2m > [22m[2mProject Quota Middleware (Integration)
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/knowledgeService.test.js[2m > [22m[2mKnowledgeService - Integration
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/attributionService.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/middleware/auditLog.test.js[2m > [22m[2mAuditLog Middleware[2m > [22m[2mshould call next() and override res.end
[22m[39m[DB:nudyzu] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/middleware/quotaMiddleware.test.js[2m > [22m[2mQuota Middleware (Integration)
[22m[39m[DB:kq1yy8] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/feedbackService.test.js
[22m[39m[DB:fydizs21] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/middleware/auditLog.test.js[2m > [22m[2mAuditLog Middleware[2m > [22m[2mshould call next() and override res.end
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js
[22m[39m[DB:xsz9f] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/middleware/quotaMiddleware.test.js[2m > [22m[2mQuota Middleware (Integration)
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/feedbackService.test.js[2m > [22m[2mBackend Service Test: FeedbackService
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/activityService.test.js
[22m[39m[DB:ar3g2k] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/activityService.test.js[2m > [22m[2mBackend Service Test: ActivityService
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/actionDecision.service.test.js[2m > [22m[2mActionDecisionService[2m > [22m[2mrecordDecision[2m > [22m[2mshould record an APPROVED decision
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/knowledgeService.test.js[2m > [22m[2mKnowledgeService - Integration
[22m[39m[DB:hoduzj] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/promoCodeService.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/aiOrchestrator.test.js[2m > [22m[2mAIOrchestrator[2m > [22m[2m_detectIntent[2m > [22m[2mshould detect EXPLAIN intent correctly
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/middleware/projectQuotaMiddleware.test.js[2m > [22m[2mProject Quota Middleware (Integration)
[22m[39m[DB:99jsse] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/knowledgeService.test.js[2m > [22m[2mKnowledgeService - Integration
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/tokenBillingService.test.js[2m > [22m[2mTokenBillingService - Integration
[22m[39m[DB:fpsgzx] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/attributionService.test.js
[22m[39m[DB:jj3abt] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/tokenBillingService.test.js[2m > [22m[2mTokenBillingService - Integration
[22m[39mProjects table created successfully (or already exists).

[90mstderr[2m | tests/unit/backend/attributionService.test.js[2m > [22m[2mAttributionService[2m > [22m[2mrecordAttribution[2m > [22m[2mshould record DEMO attribution successfully
[22m[39m[AttributionService] Record error: [Error: SQLITE_ERROR: no such table: attribution_events] {
  errno: [33m1[39m,
  code: [32m'SQLITE_ERROR'[39m
}

[90mstderr[2m | tests/unit/backend/attributionService.test.js[2m > [22m[2mAttributionService[2m > [22m[2mrecordAttribution[2m > [22m[2mshould record PROMO_CODE attribution successfully
[22m[39m[AttributionService] Record error: [Error: SQLITE_ERROR: no such table: attribution_events] {
  errno: [33m1[39m,
  code: [32m'SQLITE_ERROR'[39m
}

[90mstdout[2m | tests/unit/backend/attributionService.test.js[2m > [22m[2mAttributionService[2m > [22m[2mrecordAttribution[2m > [22m[2mshould record INVITATION attribution with metadata
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/middleware/projectQuotaMiddleware.test.js[2m > [22m[2mProject Quota Middleware (Integration)
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/ragService.test.js[2m > [22m[2mRagService - Integration
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/actionDecision.service.test.js[2m > [22m[2mActionDecisionService[2m > [22m[2mrecordDecision[2m > [22m[2mshould record an APPROVED decision
[22m[39m[DB:hgkgrp] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstderr[2m | tests/unit/backend/actionDecision.service.test.js[2m > [22m[2mActionDecisionService[2m > [22m[2mrecordDecision[2m > [22m[2mshould record an APPROVED decision
[22m[39m[ActionDecisionService] Error recording decision: Error: SQLITE_ERROR: no such table: action_decisions
--> in Database#run('INSERT INTO action_decisions (id, proposal_id, decision, decided_by_user_id, decision_reason, original_payload, modified_payload)\n' +
  '                 VALUES (?, ?, ?, ?, ?, ?, ?)', [
  'ad-62bab14d-9140-499a-991f-19b61279b948',
  'ap-001',
  'APPROVED',
  'u-1',
  'Looks good',
  null,
  null
], [Function (anonymous)])
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/ai/actionDecisionService.js:41:16
    at new Promise (<anonymous>)
    at Object.recordDecision [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/ai/actionDecisionService.js:40:16[90m)[39m
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/actionDecision.service.test.js:42:58
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m {
  errno: [33m1[39m,
  code: [32m'SQLITE_ERROR'[39m,
  __augmented: [33mtrue[39m
}

[90mstdout[2m | tests/unit/backend/aiOrchestrator.test.js[2m > [22m[2mAIOrchestrator[2m > [22m[2m_detectIntent[2m > [22m[2mshould detect EXPLAIN intent correctly
[22m[39m[DB:qg4mma] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/promoCodeService.test.js
[22m[39m[DB:ucnnvn] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/aiOrchestrator.test.js[2m > [22m[2mAIOrchestrator[2m > [22m[2m_detectIntent[2m > [22m[2mshould detect EXPLAIN intent correctly
[22m[39mProjects table created successfully (or already exists).

[90mstderr[2m | tests/unit/backend/actionDecision.service.test.js[2m > [22m[2mActionDecisionService[2m > [22m[2mrecordDecision[2m > [22m[2mshould record a MODIFIED decision with payload
[22m[39m[ActionDecisionService] Error recording decision: Error: SQLITE_ERROR: no such table: action_decisions
--> in Database#run('INSERT INTO action_decisions (id, proposal_id, decision, decided_by_user_id, decision_reason, original_payload, modified_payload)\n' +
  '                 VALUES (?, ?, ?, ?, ?, ?, ?)', [
  'ad-88ef19e7-32ad-42ca-806f-f9c58435fb7d',
  'ap-002',
  'MODIFIED',
  'u-1',
  'Adjusted units',
  null,
  '{"test":123}'
], [Function (anonymous)])
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/ai/actionDecisionService.js:41:16
    at new Promise (<anonymous>)
    at Object.recordDecision [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/ai/actionDecisionService.js:40:16[90m)[39m
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/actionDecision.service.test.js:56:58
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m {
  errno: [33m1[39m,
  code: [32m'SQLITE_ERROR'[39m,
  __augmented: [33mtrue[39m
}

 [31mâ¯[39m tests/unit/backend/promoCodeService.test.js [2m([22m[2m18 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[32m 5[2mms[22m[39m
       [32mâœ“[39m should export PROMO_TYPES[32m 1[2mms[22m[39m
       [32mâœ“[39m should export DISCOUNT_TYPES[32m 0[2mms[22m[39m
       [32mâœ“[39m should return invalid for empty code[32m 0[2mms[22m[39m
       [32mâœ“[39m should return invalid for null code[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return invalid when code not found[39m[32m 2[2mms[22m[39m
[31m       [31mÃ—[31m should return invalid for expired code[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return invalid for code not yet active[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return invalid when usage limit reached[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return valid for good code with discount[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return valid for partner code without discount[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return error for already used org code[39m[32m 0[2mms[22m[39m
       [32mâœ“[39m should throw error for missing required fields[32m 1[2mms[22m[39m
       [32mâœ“[39m should throw error for invalid promo type[32m 0[2mms[22m[39m
       [32mâœ“[39m should throw error for invalid discount type[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should create promo code successfully[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return list of promo codes[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should deactivate promo code[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return false if code not found[39m[32m 0[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/actionDecision.service.test.js[2m > [22m[2mActionDecisionService[2m > [22m[2mgetDecisionsByProposal[2m > [22m[2mshould return decisions for a proposal
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/ragService.test.js[2m > [22m[2mRagService - Integration[2m > [22m[2mgenerateEmbedding[2m > [22m[2mshould return null if no provider configured in database
[22m[39m[DB:31wbwl8] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/ragService.test.js[2m > [22m[2mRagService - Integration[2m > [22m[2mgetContext[2m > [22m[2mshould return context string without throwing
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/middleware/auditLog.test.js[2m > [22m[2mAuditLog Middleware[2m > [22m[2mshould call next() and override res.end
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/middleware/auditLog.test.js[2m > [22m[2mAuditLog Middleware[2m > [22m[2mshould call next() and override res.end
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/middleware/auditLog.test.js[2m > [22m[2mAuditLog Middleware[2m > [22m[2mshould log activity when res.end is called for 2xx POST
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator[2m > [22m[2mgetFunnelMetric[2m > [22m[2mshould calculate funnel between two events
[22m[39m[MetricsCollector] Recorded event: demo_started (b9156f19-eff4-4951-807c-294c4952c41e)

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator[2m > [22m[2mgetFunnelMetric[2m > [22m[2mshould calculate funnel between two events
[22m[39m[MetricsCollector] Recorded event: demo_started (e9d5e82e-3f1b-4b2d-8a58-a180f5d76bb3)

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator[2m > [22m[2mgetFunnelMetric[2m > [22m[2mshould calculate funnel between two events
[22m[39m[MetricsCollector] Recorded event: trial_started (0b22b638-1bad-491a-a13d-2e7ebb0c54c5)

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator[2m > [22m[2mbuildDailySnapshots[2m > [22m[2mshould build snapshots idempotently
[22m[39m[MetricsAggregator] Building daily snapshots for 2025-12-20

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator[2m > [22m[2mbuildDailySnapshots[2m > [22m[2mshould build snapshots idempotently
[22m[39m[MetricsAggregator] Created 6 snapshots for 2025-12-20

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator[2m > [22m[2mbuildDailySnapshots[2m > [22m[2mshould build snapshots idempotently
[22m[39m[MetricsAggregator] Building daily snapshots for 2025-12-20

[90mstdout[2m | tests/unit/backend/metricsAggregator.test.js[2m > [22m[2mMetricsAggregator[2m > [22m[2mbuildDailySnapshots[2m > [22m[2mshould build snapshots idempotently
[22m[39m[MetricsAggregator] Created 6 snapshots for 2025-12-20

 [32mâœ“[39m tests/unit/backend/metricsAggregator.test.js [2m([22m[2m6 tests[22m[2m)[22m[32m 85[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/aiService.test.js
[22m[39m[Database] Selected: SQLite
[Queue] Using Mock Queue for ai-tasks

[90mstdout[2m | tests/unit/backend/feedbackService.test.js[2m > [22m[2mBackend Service Test: FeedbackService
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/middleware/quotaMiddleware.test.js[2m > [22m[2mQuota Middleware (Integration)
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/activityService.test.js[2m > [22m[2mBackend Service Test: ActivityService
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/middleware/quotaMiddleware.test.js[2m > [22m[2mQuota Middleware (Integration)
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/knowledgeService.test.js[2m > [22m[2mKnowledgeService - Integration
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/attributionService.test.js[2m > [22m[2mAttributionService[2m > [22m[2mrecordAttribution[2m > [22m[2mshould record INVITATION attribution with metadata
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/attributionService.test.js[2m > [22m[2mAttributionService[2m > [22m[2mrecordAttribution[2m > [22m[2mshould record INVITATION attribution with metadata
[22m[39m[AttributionService] Attribution recorded: INVITATION for org org-3

[90mstdout[2m | tests/unit/backend/tokenBillingService.test.js[2m > [22m[2mTokenBillingService - Integration
[22m[39mDatabase initialization complete.

 [31mâ¯[39m tests/unit/backend/attributionService.test.js [2m([22m[2m18 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[32m 98[2mms[22m[39m
       [32mâœ“[39m should export SOURCE_TYPES[32m 1[2mms[22m[39m
       [32mâœ“[39m should throw error for missing organizationId[32m 1[2mms[22m[39m
       [32mâœ“[39m should throw error for missing sourceType[32m 0[2mms[22m[39m
       [32mâœ“[39m should throw error for invalid sourceType[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should record DEMO attribution successfully[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should record PROMO_CODE attribution successfully[39m[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should record INVITATION attribution with metadata[39m[32m 90[2mms[22m[39m
[31m       [31mÃ—[31m should return all attribution events for org[39m[32m 1[2mms[22m[39m
       [32mâœ“[39m should return empty array for org with no attribution[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return first attribution event[39m[32m 0[2mms[22m[39m
       [32mâœ“[39m should return null for org with no attribution[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return true if org has attribution[39m[32m 0[2mms[22m[39m
       [32mâœ“[39m should return false if org has no attribution[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should export with filters[39m[32m 0[2mms[22m[39m
       [32mâœ“[39m should export all without filters[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return partner summary for settlements[39m[32m 1[2mms[22m[39m
       [32mâœ“[39m should not expose update methods[32m 0[2mms[22m[39m
       [32mâœ“[39m should only have append-only recordAttribution[32m 0[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/aiService.test.js
[22m[39m[DB:8v2wjc] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstderr[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mAIService Unit Tests[2m > [22m[2mgenerateInitiatives[2m > [22m[2mshould return empty array on JSON parse error
[22m[39mLLM Call Error Error: AI Provider not configured.
    at Object.callLLM [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/services/aiService.js:172:41[90m)[39m
    at Object.generateInitiatives [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/services/aiService.js:655:29[90m)[39m
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/aiService.test.js:213:33
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | tests/unit/backend/middleware/auditLog.test.js[2m > [22m[2mAuditLog Middleware[2m > [22m[2mshould NOT log for GET requests
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mAIService Unit Tests[2m > [22m[2mstreamLLM[2m > [22m[2mshould handle errors in stream
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/middleware/projectQuotaMiddleware.test.js[2m > [22m[2mProject Quota Middleware (Integration)
[22m[39mDatabase initialization complete.

 [32mâœ“[39m tests/unit/backend/middleware/auditLog.test.js [2m([22m[2m3 tests[22m[2m)[22m[32m 205[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/middleware/projectQuotaMiddleware.test.js[2m > [22m[2mProject Quota Middleware (Integration)
[22m[39m[Database] Selected: SQLite

 [32mâœ“[39m tests/unit/backend/knowledgeService.test.js [2m([22m[2m11 tests[22m[2m)[22m[32m 164[2mms[22m[39m
[90mstderr[2m | tests/unit/backend/middleware/projectQuotaMiddleware.test.js[2m > [22m[2mProject Quota Middleware (Integration)[2m > [22m[2mshould handle errors gracefully (e.g. project not found)
[22m[39mProject quota check error: Error: Project not found
    at Statement.<anonymous> [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/services/usageService.js:300:41[90m)[39m
    at Statement.replacement [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/node_modules/[4msqlite3[24m/lib/trace.js:25:27[90m)[39m
    at Statement.replacement [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/node_modules/[4msqlite3[24m/lib/trace.js:25:27[90m)[39m

 [32mâœ“[39m tests/unit/backend/middleware/projectQuotaMiddleware.test.js [2m([22m[2m6 tests[22m[2m)[22m[32m 175[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/aiOrchestrator.test.js[2m > [22m[2mAIOrchestrator[2m > [22m[2mprocessMessage[2m > [22m[2mshould process a message successfully
[22m[39mDatabase initialization complete.

 [31mâ¯[39m tests/unit/backend/aiOrchestrator.test.js [2m([22m[2m14 tests[22m[2m | [22m[31m2 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[32m 193[2mms[22m[39m
       [32mâœ“[39m should detect EXPLAIN intent correctly[32m 86[2mms[22m[39m
       [32mâœ“[39m should detect GUIDE intent correctly[32m 0[2mms[22m[39m
       [32mâœ“[39m should detect ANALYZE intent correctly[32m 0[2mms[22m[39m
       [32mâœ“[39m should detect DO intent correctly[32m 0[2mms[22m[39m
       [32mâœ“[39m should detect TEACH intent correctly[32m 0[2mms[22m[39m
       [32mâœ“[39m should default to EXPLAIN for unclear intent[32m 0[2mms[22m[39m
       [32mâœ“[39m should force ADVISOR role if regulatory mode is enabled[32m 1[2mms[22m[39m
       [32mâœ“[39m should select PMO_MANAGER for GUIDE intent[32m 0[2mms[22m[39m
       [32mâœ“[39m should fallback to ADVISOR if selected role is not active[32m 0[2mms[22m[39m
       [32mâœ“[39m should process a message successfully[32m 98[2mms[22m[39m
[31m       [31mÃ—[31m should include regulatory prompt when regulatory mode is enabled[39m[32m 3[2mms[22m[39m
       [2m[90mâ†“[39m[22m should handle context building errors gracefully
       [32mâœ“[39m should default to ADVISOR if role selection returns null[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing project ID (General Chat)[39m[32m 1[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/middleware/quotaMiddleware.test.js [2m([22m[2m8 tests[22m[2m)[22m[32m 212[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/actionDecision.service.test.js[2m > [22m[2mActionDecisionService[2m > [22m[2mgetDecisionsByProposal[2m > [22m[2mshould return decisions for a proposal
[22m[39mDatabase initialization complete.

 [31mâ¯[39m tests/unit/backend/actionDecision.service.test.js [2m([22m[2m6 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[32m 219[2mms[22m[39m
[31m       [31mÃ—[31m should record an APPROVED decision[39m[32m 65[2mms[22m[39m
[31m       [31mÃ—[31m should record a MODIFIED decision with payload[39m[32m 9[2mms[22m[39m
       [32mâœ“[39m should throw error for invalid decision type[32m 1[2mms[22m[39m
       [32mâœ“[39m should throw error for missing proposal_id[32m 0[2mms[22m[39m
[31m       [31mÃ—[31m should return decisions for a proposal[39m[32m 142[2mms[22m[39m
[31m       [31mÃ—[31m should return the full audit log[39m[32m 1[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/ragService.test.js[2m > [22m[2mRagService - Integration[2m > [22m[2mgetContext[2m > [22m[2mshould return context string without throwing
[22m[39mDatabase initialization complete.

 [32mâœ“[39m tests/unit/backend/ragService.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 238[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/tokenBillingService.test.js [2m([22m[2m16 tests[22m[2m)[22m[32m 254[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mAIService Unit Tests[2m > [22m[2mstreamLLM[2m > [22m[2mshould handle errors in stream
[22m[39mDatabase initialization complete.

[90mstderr[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mAIService Unit Tests[2m > [22m[2mstreamLLM[2m > [22m[2mshould handle errors in stream
[22m[39mStream LLM Error Error: AI Provider not configured.
    at Object.streamLLM [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/services/aiService.js:398:41[90m)[39m
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/aiService.test.js:241:30
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mAIService Unit Tests[2m > [22m[2mGeneration Methods[2m > [22m[2menrichInitiative[2m > [22m[2mshould maintain structure and fallback to LLM
[22m[39mWeb Search failed, using LLM knowledge Error: Web Fail
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/aiService.test.js:311:59
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mAIService Unit Tests[2m > [22m[2mGeneration Methods[2m > [22m[2mtestProviderConnection[2m > [22m[2mshould test OpenAI connection
[22m[39m[AiService] Testing connection for: openai

[90mstderr[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mAIService Unit Tests[2m > [22m[2mAdvanced Streaming[2m > [22m[2mshould handle OpenAI stream error
[22m[39mStream LLM Error Error: Stream Error
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/aiService.test.js:237:69
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mExtended AI Capabilities[2m > [22m[2mgenerateTaskInsight[2m > [22m[2mshould return fallback object on LLM failure/JSON error
[22m[39mTask Insight Error Error: LLM Fail
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/aiService.test.js:630:42
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mExtended AI Capabilities[2m > [22m[2mgenerateExecutionStrategy[2m > [22m[2mshould return empty structure on error
[22m[39mExecution Gen Error SyntaxError: Unexpected token 'N', "Not JSON" is not valid JSON
    at JSON.parse (<anonymous>)
    at Object.generateExecutionStrategy [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/services/aiService.js:802:25[90m)[39m
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/aiService.test.js:658:28
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mExtended AI Capabilities[2m > [22m[2mgenerateInsights (Pre-Mortem)[2m > [22m[2mshould return fallback on error
[22m[39mInsights Gen Error Error: Fail
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/aiService.test.js:679:42
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | tests/unit/backend/aiService.test.js[2m > [22m[2mExtended AI Capabilities[2m > [22m[2mgenerateStrategicFit[2m > [22m[2mshould return fallback on error
[22m[39mFit Check Error SyntaxError: Unexpected token 'B', "Bad JSON" is not valid JSON
    at JSON.parse (<anonymous>)
    at Object.generateStrategicFit [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mserver/services/aiService.js:864:25[90m)[39m
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/backend/aiService.test.js:704:28
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

 [32mâœ“[39m tests/unit/backend/aiService.test.js [2m([22m[2m36 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[32m 151[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/feedbackService.test.js [2m([22m[2m6 tests[22m[2m)[22m[33m 658[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/billingService.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/billingService.test.js
[22m[39m[DB:m0k2t] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/billingService.test.js[2m > [22m[2mBillingService (Unit)
[22m[39mProjects table created successfully (or already exists).

 [32mâœ“[39m tests/unit/backend/activityService.test.js [2m([22m[2m6 tests[22m[2m)[22m[33m 765[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/billingService.test.js[2m > [22m[2mBillingService (Unit)
[22m[39mDatabase initialization complete.

 [32mâœ“[39m tests/unit/backend/billingService.test.js [2m([22m[2m4 tests[22m[2m)[22m[32m 126[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/metricsCollector.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js
[22m[39m[DB:f2o1] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mrecordEvent[2m > [22m[2mshould record an event successfully
[22m[39m[MetricsCollector] Recorded event: trial_started (f8e97e4b-319e-4e2a-928e-5198b3863466)

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mrecordEvent[2m > [22m[2mshould accept minimal payload
[22m[39m[MetricsCollector] Recorded event: demo_started (9d9339a7-d2ff-478b-bca2-afbf2488e1c3)

[90mstderr[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mrecordEvent[2m > [22m[2mshould warn on unknown event type but still record
[22m[39m[MetricsCollector] Unknown event type: unknown_event_type

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mrecordEvent[2m > [22m[2mshould warn on unknown event type but still record
[22m[39m[MetricsCollector] Recorded event: unknown_event_type (f430c0d0-0705-4109-a977-024a525b115a)

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mgetEvents[2m > [22m[2mshould query events by type
[22m[39m[MetricsCollector] Recorded event: trial_started (84e8e3f9-66e4-401a-bcdb-5d2e2eeb6afa)

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mgetEvents[2m > [22m[2mshould query events by type
[22m[39m[MetricsCollector] Recorded event: trial_started (545097e1-9d3f-4ea1-9946-1e75d058f4ec)

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mgetUniqueOrgCount[2m > [22m[2mshould return unique org count
[22m[39m[MetricsCollector] Recorded event: trial_started (148bb5c7-b350-4bdb-990a-1a75720bd75b)

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mgetUniqueOrgCount[2m > [22m[2mshould return unique org count
[22m[39m[MetricsCollector] Recorded event: trial_started (75d8a1ce-578d-48c7-804c-6cc8563f506f)

[90mstdout[2m | tests/unit/backend/metricsCollector.test.js[2m > [22m[2mMetricsCollector[2m > [22m[2mgetUniqueOrgCount[2m > [22m[2mshould return unique org count
[22m[39m[MetricsCollector] Recorded event: trial_started (022da3ae-00bf-4c0c-827d-9db476964996)

 [32mâœ“[39m tests/unit/backend/metricsCollector.test.js [2m([22m[2m18 tests[22m[2m)[22m[32m 136[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/middleware/planLimits.test.js[2m > [22m[2mPlanLimits Middleware[2m > [22m[2mshould return 403 if no organization found in user
[22m[39m[Database] Selected: SQLite

[90mstderr[2m | tests/unit/pdfExport.test.ts[2m > [22m[2mService Test: pdfExport[2m > [22m[2mexportReportToPDF[2m > [22m[2mreturns false when element is not found
[22m[39mElement with id non-existent not found

[90mstderr[2m | tests/unit/pdfExport.test.ts[2m > [22m[2mService Test: pdfExport[2m > [22m[2mexportReportToPDF[2m > [22m[2mexports PDF successfully
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.
PDF Export failed: TypeError: () => new MockJsPDF() is not a constructor
    at new j [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/spy[24m/dist/index.js:262:27[90m)[39m
    at Module.exportReportToPDF [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mservices/pdf/pdfExport.ts:30:21[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/backend/middleware/planLimits.test.js[2m > [22m[2mPlanLimits Middleware[2m > [22m[2mshould return 403 if no organization found in user
[22m[39m[DB:lyog7a] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/middleware/planLimits.test.js[2m > [22m[2mPlanLimits Middleware[2m > [22m[2mshould return 403 if no organization found in user
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/usageService.test.js[2m > [22m[2mUsageService - Integration
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/usageService.test.js[2m > [22m[2mUsageService - Integration
[22m[39m[DB:l84hi6] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/analyticsService.test.js[2m > [22m[2mAnalyticsService - Integration
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/usageService.test.js[2m > [22m[2mUsageService - Integration
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/analyticsService.test.js[2m > [22m[2mAnalyticsService - Integration
[22m[39m[DB:bnypgu] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/analyticsService.test.js[2m > [22m[2mAnalyticsService - Integration
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/emailService.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/scmsServices.test.js[2m > [22m[2mNotificationService[2m > [22m[2mNOTIFICATION_TYPES[2m > [22m[2mshould have notification types defined
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/scmsServices.test.js[2m > [22m[2mMyWorkService[2m > [22m[2mService Structure[2m > [22m[2mshould export getMyWork function
[22m[39m[DB:w5jxia] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/emailService.test.js
[22m[39m[DB:vpb8ji] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/scmsServices.test.js[2m > [22m[2mExecutionMonitorService[2m > [22m[2mService Structure[2m > [22m[2mshould export runDailyMonitor function
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/aiCoreLayer.test.js[2m > [22m[2mAIContextBuilder[2m > [22m[2mService Structure[2m > [22m[2mshould export buildContext function
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/emailService.test.js[2m > [22m[2mBackend Service Test: EmailService
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/middleware/planLimits.test.js[2m > [22m[2mPlanLimits Middleware[2m > [22m[2mshould return 403 if no organization found in user
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/dependencyService.test.js[2m > [22m[2mDependencyService[2m > [22m[2maddDependency[2m > [22m[2mshould prevent self-dependency
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/middleware/planLimits.test.js[2m > [22m[2mPlanLimits Middleware[2m > [22m[2mshould return 403 if no organization found in user
[22m[39m[Database] Selected: SQLite

[90mstderr[2m | tests/unit/backend/middleware/planLimits.test.js[2m > [22m[2mPlanLimits Middleware[2m > [22m[2mshould handle undefined limits gracefully (warn and allow)
[22m[39mLimit key unknown_limit_key not found for plan free

 [32mâœ“[39m tests/unit/backend/scmsServices.test.js [2m([22m[2m39 tests[22m[2m)[22m[32m 85[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/middleware/planLimits.test.js [2m([22m[2m8 tests[22m[2m)[22m[32m 222[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/aiCoreLayer.test.js[2m > [22m[2mAIPolicyEngine[2m > [22m[2mPOLICY_LEVELS[2m > [22m[2mshould define ADVISORY level
[22m[39m[DB:k456nh] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/dependencyService.test.js[2m > [22m[2mDependencyService[2m > [22m[2maddDependency[2m > [22m[2mshould insert dependency correctly
[22m[39m[DB:m3bh3] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/aiCoreLayer.test.js [2m([22m[2m56 tests[22m[2m)[22m[32m 75[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/aiActions.test.js[2m > [22m[2mAIActionExecutor[2m > [22m[2mACTION_TYPES[2m > [22m[2mshould have 7 action types
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/dependencyService.test.js
[22m[39mProjects table created successfully (or already exists).

 [32mâœ“[39m tests/unit/backend/dependencyService.test.js [2m([22m[2m4 tests[22m[2m)[22m[32m 68[2mms[22m[39m
[90mstderr[2m | tests/unit/pdfExport.test.ts[2m > [22m[2mService Test: pdfExport[2m > [22m[2mexportReportToPDF[2m > [22m[2mhandles errors gracefully
[22m[39mPDF Export failed: Error: Canvas error
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/pdfExport.test.ts:79:52
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | tests/unit/pdfExport.test.ts[2m > [22m[2mService Test: pdfExport[2m > [22m[2mexportDashboardToPDF[2m > [22m[2mcreates PDF with metadata
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.
Dashboard PDF Export failed: TypeError: () => new MockJsPDF() is not a constructor
    at new j [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/spy[24m/dist/index.js:262:27[90m)[39m
    at Module.exportDashboardToPDF [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mservices/pdf/pdfExport.ts:70:21[90m)[39m
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/pdfExport.test.ts:89:19
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m

[90mstderr[2m | tests/unit/pdfExport.test.ts[2m > [22m[2mService Test: pdfExport[2m > [22m[2mexportDashboardToPDF[2m > [22m[2mhandles optional metadata
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.
Dashboard PDF Export failed: TypeError: () => new MockJsPDF() is not a constructor
    at new j [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/spy[24m/dist/index.js:262:27[90m)[39m
    at Module.exportDashboardToPDF [90m(/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mservices/pdf/pdfExport.ts:70:21[90m)[39m
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/pdfExport.test.ts:100:19
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m

 [32mâœ“[39m tests/unit/pdfExport.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 205[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/pmoStandardsMapping.test.js[2m > [22m[2mPMOStandardsMapping[2m > [22m[2mgetMapping[2m > [22m[2mshould return mapping for known concept
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/usageService.test.js[2m > [22m[2mUsageService - Integration
[22m[39mDatabase initialization complete.

[90mstdout[2m | tests/unit/backend/aiActions.test.js[2m > [22m[2mAIAuditLogger[2m > [22m[2mService Structure[2m > [22m[2mshould export logInteraction function
[22m[39m[DB:0gjnom] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/usageService.test.js [2m([22m[2m4 tests[22m[2m)[22m[32m 202[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/aiActions.test.js [2m([22m[2m23 tests[22m[2m)[22m[32m 64[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/pmoStandardsMapping.test.js[2m > [22m[2mPMOStandardsMapping[2m > [22m[2mgetMapping[2m > [22m[2mshould return mapping for known concept
[22m[39m[DB:dlhtu] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/pmoStandardsMapping.test.js [2m([22m[2m7 tests[22m[2m)[22m[32m 65[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/analyticsService.test.js[2m > [22m[2mAnalyticsService - Integration
[22m[39mDatabase initialization complete.

 [32mâœ“[39m tests/unit/backend/analyticsService.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 235[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/pmoHealthService.test.js[2m > [22m[2mPMOHealthService[2m > [22m[2mgetHealthSnapshot[2m > [22m[2mshould return complete snapshot
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/pmoHealthService.test.js[2m > [22m[2mPMOHealthService[2m > [22m[2mgetHealthSnapshot[2m > [22m[2mshould return complete snapshot
[22m[39m[DB:ip2a1] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

[90mstdout[2m | tests/unit/backend/pmoHealthService.test.js[2m > [22m[2mPMOHealthService[2m > [22m[2mgetHealthSnapshot[2m > [22m[2mshould return complete snapshot
[22m[39m[PMOHealthService] Snapshot generated in 0ms for project proj1

 [32mâœ“[39m tests/unit/backend/pmoHealthService.test.js [2m([22m[2m2 tests[22m[2m)[22m[32m 129[2mms[22m[39m
[90mstdout[2m | Statement.<anonymous> (/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/server/database.sqlite.active.js:103:26)
[22m[39mProjects table created successfully (or already exists).

[90mstdout[2m | tests/unit/backend/emailService.test.js[2m > [22m[2mBackend Service Test: EmailService
[22m[39mDatabase initialization complete.

 [32mâœ“[39m tests/unit/backend/emailService.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 275[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/helpService.test.js[2m > [22m[2mHelpService Constants and Validation[2m > [22m[2mEVENT_TYPES[2m > [22m[2mshould define all required event types
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/helpService.test.js
[22m[39m[DB:lpj7d] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/helpService.test.js [2m([22m[2m13 tests[22m[2m)[22m[32m 45[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/criticalPathService.test.js[2m > [22m[2mCriticalPathService[2m > [22m[2mcalculateCriticalPath[2m > [22m[2mshould calculate path
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/criticalPathService.test.js
[22m[39m[DB:zciy7] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/criticalPathService.test.js [2m([22m[2m2 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[32m 41[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/stageGateService.test.js[2m > [22m[2mStageGateService[2m > [22m[2mgetGateType[2m > [22m[2mshould return correct gate type
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/stageGateService.test.js
[22m[39m[DB:30s2zlu] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/stageGateService.test.js [2m([22m[2m6 tests[22m[2m)[22m[32m 56[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/myWorkService.test.js[2m > [22m[2mMyWorkService[2m > [22m[2mgetMyWork[2m > [22m[2mshould aggregate work
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/myWorkService.test.js
[22m[39m[DB:4cx9k] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/myWorkService.test.js [2m([22m[2m2 tests[22m[2m)[22m[32m 38[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/pmoDomainRegistry.test.js[2m > [22m[2mPMODomainRegistry[2m > [22m[2mgetAllDomains[2m > [22m[2mshould return domains
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/scmsLifecycle.test.js[2m > [22m[2mStageGateService[2m > [22m[2mGate Types[2m > [22m[2mshould define READINESS_GATE
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/backend/pmoDomainRegistry.test.js
[22m[39m[DB:23j0qg] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/pmoDomainRegistry.test.js [2m([22m[2m2 tests[22m[2m)[22m[32m 30[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/scmsLifecycle.test.js
[22m[39m[DB:2009zs] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/backend/scmsLifecycle.test.js [2m([22m[2m16 tests[22m[2m)[22m[32m 33[2mms[22m[39m
 [32mâœ“[39m tests/unit/actionProposalEngine.test.js [2m([22m[2m6 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/scmsGovernance.test.js [2m([22m[2m17 tests[22m[2m)[22m[32m 8[2mms[22m[39m
 [32mâœ“[39m tests/unit/drdStructure.test.ts [2m([22m[2m7 tests[22m[2m)[22m[32m 6[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/aiExplainabilityService.test.js[2m > [22m[2mSample Output[2m > [22m[2mgenerates sample AIExplanation matching the spec
[22m[39m
========== SAMPLE AIExplanation JSON ==========
{
  "aiRole": "ADVISOR",
  "regulatoryMode": false,
  "confidenceLevel": "HIGH",
  "reasoningSummary": "Based on 3 overdue task(s), 1 pending decision(s), current phase: Execution, 5 project memory item(s) consulted",
  "dataUsed": {
    "projectData": true,
    "projectMemoryCount": 5,
    "externalSources": []
  },
  "constraintsApplied": [
    "AI Role: ADVISOR (explain/suggest only, no mutations)",
    "AI Policy: ADVISORY mode",
    "Phase Gate: Execution"
  ],
  "timestamp": "2025-12-20T21:27:15.356Z"
}
================================================


 [32mâœ“[39m tests/unit/backend/aiExplainabilityService.test.js [2m([22m[2m35 tests[22m[2m)[22m[32m 4[2mms[22m[39m
[90mstdout[2m | tests/unit/hooks/useAIStream.test.ts[2m > [22m[2mHook Test: useAIStream[2m > [22m[2mcalls API with correct parameters
[22m[39m[DEBUG-D] startStream entry: {
  msgLength: [33m12[39m,
  historyLength: [33m0[39m,
  hasSystemPrompt: [33mtrue[39m,
  hasContext: [33mfalse[39m
}
[DEBUG-A,C] startStream onDone: { responseLength: [33m11[39m }

[90mstdout[2m | tests/unit/hooks/useAIStream.test.ts[2m > [22m[2mHook Test: useAIStream[2m > [22m[2mupdates stream content as chunks arrive
[22m[39m[DEBUG-D] startStream entry: {
  msgLength: [33m4[39m,
  historyLength: [33m0[39m,
  hasSystemPrompt: [33mfalse[39m,
  hasContext: [33mfalse[39m
}
[DEBUG-A,C] startStream onDone: { responseLength: [33m11[39m }

[90mstdout[2m | tests/unit/hooks/useAIStream.test.ts[2m > [22m[2mHook Test: useAIStream[2m > [22m[2mcalls onStreamDone callback when stream completes
[22m[39m[DEBUG-D] startStream entry: {
  msgLength: [33m4[39m,
  historyLength: [33m0[39m,
  hasSystemPrompt: [33mfalse[39m,
  hasContext: [33mfalse[39m
}
[DEBUG-A,C] startStream onDone: { responseLength: [33m8[39m }

[90mstdout[2m | tests/unit/hooks/useAIStream.test.ts[2m > [22m[2mHook Test: useAIStream[2m > [22m[2mhandles stream errors
[22m[39m[DEBUG-D] startStream entry: {
  msgLength: [33m4[39m,
  historyLength: [33m0[39m,
  hasSystemPrompt: [33mfalse[39m,
  hasContext: [33mfalse[39m
}

[90mstdout[2m | tests/unit/hooks/useAIStream.test.ts[2m > [22m[2mHook Test: useAIStream[2m > [22m[2mhandles stream errors
[22m[39m[DEBUG-A,C] startStream error: { errorMsg: [32m'Error: Stream failed'[39m }

[90mstderr[2m | tests/unit/hooks/useAIStream.test.ts[2m > [22m[2mHook Test: useAIStream[2m > [22m[2mhandles stream errors
[22m[39mAI Stream Error: Error: Stream failed
    at [90m/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mtests/unit/hooks/useAIStream.test.ts:87:23
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/unit/hooks/useAIStream.test.ts[2m > [22m[2mHook Test: useAIStream[2m > [22m[2msets bot typing state correctly
[22m[39m[DEBUG-D] startStream entry: {
  msgLength: [33m4[39m,
  historyLength: [33m0[39m,
  hasSystemPrompt: [33mfalse[39m,
  hasContext: [33mfalse[39m
}
[DEBUG-A,C] startStream onDone: { responseLength: [33m11[39m }

 [32mâœ“[39m tests/unit/hooks/useAIStream.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 56[2mms[22m[39m
 [32mâœ“[39m tests/unit/hooks/useIndependentAI.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/hooks/useScreenContext.test.ts [2m([22m[2m2 tests[22m[2m)[22m[32m 10[2mms[22m[39m
 [32mâœ“[39m tests/unit/transformationEngine.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/middleware/adminMiddleware.test.js [2m([22m[2m4 tests[22m[2m)[22m[32m 4[2mms[22m[39m
[90mstdout[2m | tests/unit/api.service.test.ts[2m > [22m[2mApi Service Unit Tests[2m > [22m[2mlogin: should store token and return user on success
[22m[39mApi.login called: { email: [32m'test@test.com'[39m, url: [32m'/api/auth/login'[39m }

[90mstdout[2m | tests/unit/api.service.test.ts[2m > [22m[2mApi Service Unit Tests[2m > [22m[2mlogin: should store token and return user on success
[22m[39mLogin response status: [90mundefined[39m

[90mstdout[2m | tests/unit/api.service.test.ts[2m > [22m[2mApi Service Unit Tests[2m > [22m[2mlogin: should store token and return user on success
[22m[39mLogin response data: { token: [32m'abc-123'[39m, user: { id: [32m'1'[39m, email: [32m'test@test.com'[39m } }

[90mstdout[2m | tests/unit/api.service.test.ts[2m > [22m[2mApi Service Unit Tests[2m > [22m[2mlogin: should throw error on failure
[22m[39mApi.login called: { email: [32m'test@test.com'[39m, url: [32m'/api/auth/login'[39m }

[90mstdout[2m | tests/unit/api.service.test.ts[2m > [22m[2mApi Service Unit Tests[2m > [22m[2mlogin: should throw error on failure
[22m[39mLogin response status: [90mundefined[39m

[90mstdout[2m | tests/unit/api.service.test.ts[2m > [22m[2mApi Service Unit Tests[2m > [22m[2mlogin: should throw error on failure
[22m[39mLogin response data: { error: [32m'Invalid credentials'[39m }

 [32mâœ“[39m tests/unit/api.service.test.ts [2m([22m[2m6 tests[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/middleware/superAdminMiddleware.test.js [2m([22m[2m3 tests[22m[2m)[22m[32m 5[2mms[22m[39m
[90mstdout[2m | tests/unit/regulatoryModeGuard.test.js
[22m[39m[Database] Selected: SQLite

[90mstdout[2m | tests/unit/regulatoryModeGuard.test.js
[22m[39m[DB:paljfr] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/regulatoryModeGuard.test.js [2m([22m[2m31 tests[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m tests/unit/store.test.ts [2m([22m[2m19 tests[22m[2m)[22m[32m 4[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/financialService.test.js [2m([22m[2m10 tests[22m[2m)[22m[32m 3[2mms[22m[39m
 [32mâœ“[39m tests/unit/analytics.service.test.ts [2m([22m[2m8 tests[22m[2m)[22m[32m 2[2mms[22m[39m
[90mstdout[2m | tests/unit/aiRoleGuard.test.js
[22m[39m[Database] Selected: SQLite

 [32mâœ“[39m tests/unit/aiResponsePostProcessor.test.js [2m([22m[2m20 tests[22m[2m)[22m[32m 3[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/aiExternalData.test.js [2m([22m[2m5 tests[22m[2m)[22m[32m 1[2mms[22m[39m
[90mstdout[2m | tests/unit/aiRoleGuard.test.js
[22m[39m[DB:gibjul] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/aiRoleGuard.test.js [2m([22m[2m16 tests[22m[2m)[22m[32m 3[2mms[22m[39m
 [32mâœ“[39m tests/unit/roi.test.ts [2m([22m[2m3 tests[22m[2m)[22m[32m 1[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/middleware/authMiddleware.test.js
[22m[39m[Database] Selected: SQLite

 [32mâœ“[39m tests/unit/utils.test.ts [2m([22m[2m1 test[22m[2m)[22m[32m 1[2mms[22m[39m
[90mstdout[2m | tests/unit/backend/middleware/authMiddleware.test.js
[22m[39m[DB:7ulh8] Initializing database at :memory:
Connected to the SQLite database.
Created billing tables and seeded default subscription plans.
Seeded SuperAdmin and DBR77 Users.

 [32mâœ“[39m tests/unit/transformationScenarios.test.ts [2m([22m[2m5 tests[22m[2m)[22m[32m 1[2mms[22m[39m
 [32mâœ“[39m tests/unit/backend/middleware/authMiddleware.test.js [2m([22m[2m6 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[32m 2[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Suites 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/unit/backend/accessPolicyService.test.js[2m [ tests/unit/backend/accessPolicyService.test.js ][22m
[31m[1mError[22m: Cannot find module '../../server/database'
Require stack:
- /Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/tests/unit/backend/accessPolicyService.test.js[39m
[36m [2mâ¯[22m tests/unit/backend/accessPolicyService.test.js:[2m7:12[22m[39m
    [90m  5| [39m */[39m
    [90m  6| [39m
    [90m  7| [39m[35mconst[39m db [33m=[39m [34mrequire[39m([32m'../../server/database'[39m)[33m;[39m
    [90m   | [39m           [31m^[39m
    [90m  8| [39m
    [90m  9| [39m[90m// Mock the database before importing AccessPolicyService[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/26]âŽ¯[22m[39m


[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 25 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/unit/backend/actionDecision.service.test.js[2m > [22mActionDecisionService[2m > [22mrecordDecision[2m > [22mshould record an APPROVED decision
[31m[1mError[22m: SQLITE_ERROR: no such table: action_decisions[39m
[36m [2mâ¯[22m server/ai/actionDecisionService.js:[2m41:16[22m[39m
    [90m 39| [39m
    [90m 40| [39m        [35mreturn[39m [35mnew[39m [33mPromise[39m((resolve[33m,[39m reject) [33m=>[39m {
    [90m 41| [39m            db[33m.[39m[34mrun[39m(
    [90m   | [39m               [31m^[39m
    [90m 42| [39m                `INSERT INTO action_decisions (id, proposal_id, decisiâ€¦
    [90m 43| [39m                 VALUES (?, ?, ?, ?, ?, ?, ?)`[39m[33m,[39m
[90m [2mâ¯[22m Object.recordDecision server/ai/actionDecisionService.js:[2m40:16[22m[39m
[90m [2mâ¯[22m tests/unit/backend/actionDecision.service.test.js:[2m42:58[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/actionDecision.service.test.js[2m > [22mActionDecisionService[2m > [22mrecordDecision[2m > [22mshould record a MODIFIED decision with payload
[31m[1mError[22m: SQLITE_ERROR: no such table: action_decisions[39m
[36m [2mâ¯[22m server/ai/actionDecisionService.js:[2m41:16[22m[39m
    [90m 39| [39m
    [90m 40| [39m        [35mreturn[39m [35mnew[39m [33mPromise[39m((resolve[33m,[39m reject) [33m=>[39m {
    [90m 41| [39m            db[33m.[39m[34mrun[39m(
    [90m   | [39m               [31m^[39m
    [90m 42| [39m                `INSERT INTO action_decisions (id, proposal_id, decisiâ€¦
    [90m 43| [39m                 VALUES (?, ?, ?, ?, ?, ?, ?)`[39m[33m,[39m
[90m [2mâ¯[22m Object.recordDecision server/ai/actionDecisionService.js:[2m40:16[22m[39m
[90m [2mâ¯[22m tests/unit/backend/actionDecision.service.test.js:[2m56:58[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/actionDecision.service.test.js[2m > [22mActionDecisionService[2m > [22mgetDecisionsByProposal[2m > [22mshould return decisions for a proposal
[31m[1mAssertionError[22m: expected [] to have a length of 1 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 1[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/unit/backend/actionDecision.service.test.js:[2m87:31[22m[39m
    [90m 85| [39m        [34mit[39m([32m'should return decisions for a proposal'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m 86| [39m            const decisions = await ActionDecisionService.getDecisionsâ€¦
    [90m 87| [39m            [34mexpect[39m(decisions)[33m.[39m[34mtoHaveLength[39m([34m1[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 88| [39m            [34mexpect[39m(decisions[[34m0[39m][33m.[39mproposal_id)[33m.[39m[34mtoBe[39m([32m'ap-001'[39m)[33m;[39m
    [90m 89| [39m        })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/actionDecision.service.test.js[2m > [22mActionDecisionService[2m > [22mgetAuditLog[2m > [22mshould return the full audit log
[31m[1mAssertionError[22m: expected [] to have a length of 1 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 1[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/unit/backend/actionDecision.service.test.js:[2m95:25[22m[39m
    [90m 93| [39m        [34mit[39m([32m'should return the full audit log'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m 94| [39m            [35mconst[39m log [33m=[39m [35mawait[39m [33mActionDecisionService[39m[33m.[39m[34mgetAuditLog[39m()[33m;[39m
    [90m 95| [39m            [34mexpect[39m(log)[33m.[39m[34mtoHaveLength[39m([34m1[39m)[33m;[39m
    [90m   | [39m                        [31m^[39m
    [90m 96| [39m            [34mexpect[39m(log[[34m0[39m][33m.[39mfirst_name)[33m.[39m[34mtoBe[39m([32m'Admin'[39m)[33m;[39m
    [90m 97| [39m        })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiOrchestrator.test.js[2m > [22mAIOrchestrator[2m > [22mprocessMessage[2m > [22mshould include regulatory prompt when regulatory mode is enabled
[31m[1mAssertionError[22m: the given combination of arguments (undefined and string) is invalid for this assertion. You can use an array, a map, an object, a set, a string, or a weakset instead of a string[39m
[36m [2mâ¯[22m tests/unit/backend/aiOrchestrator.test.js:[2m159:35[22m[39m
    [90m157| [39m            const result = await AIOrchestrator.processMessage('Executâ€¦
    [90m158| [39m            // The prompt contains a complex string, check for key heaâ€¦
    [90m159| [39m            expect(result.prompt).toContain('REGULATORY COMPLIANCE MODâ€¦
    [90m   | [39m                                  [31m^[39m
    [90m160| [39m        })[33m;[39m
    [90m161| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/aiOrchestrator.test.js[2m > [22mAIOrchestrator[2m > [22mprocessMessage[2m > [22mshould handle missing project ID (General Chat)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'projectMemory')[39m
[36m [2mâ¯[22m tests/unit/backend/aiOrchestrator.test.js:[2m178:43[22m[39m
    [90m176| [39m        it('should handle missing project ID (General Chat)', async ()â€¦
    [90m177| [39m            const result = await AIOrchestrator.processMessage('Generaâ€¦
    [90m178| [39m            [34mexpect[39m(result[33m.[39mresponseContext[33m.[39mprojectMemory)[33m.[39m[34mtoBeNull[39m()[33m;[39m
    [90m   | [39m                                          [31m^[39m
    [90m179| [39m            // Role config logic is skipped for null project in procesâ€¦
    [90m180| [39m            [90m// but defaults are used for aiGovernance[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/attributionService.test.js[2m > [22mAttributionService[2m > [22mrecordAttribution[2m > [22mshould record DEMO attribution successfully
[41m[1m FAIL [22m[49m tests/unit/backend/attributionService.test.js[2m > [22mAttributionService[2m > [22mrecordAttribution[2m > [22mshould record PROMO_CODE attribution successfully
[31m[1mError[22m: SQLITE_ERROR: no such table: attribution_events[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/attributionService.test.js[2m > [22mAttributionService[2m > [22mrecordAttribution[2m > [22mshould record INVITATION attribution with metadata
[31m[1mAssertionError[22m: expected '335a3a60-fb51-40d7-94e0-d1cfb7dadbf7' to be 'test-attr-uuid-1234' // Object.is equality[39m

Expected: [32m"test-attr-uuid-1234"[39m
Received: [31m"335a3a60-fb51-40d7-94e0-d1cfb7dadbf7"[39m

[36m [2mâ¯[22m tests/unit/backend/attributionService.test.js:[2m118:36[22m[39m
    [90m116| [39m            })[33m;[39m
    [90m117| [39m
    [90m118| [39m            [34mexpect[39m(result[33m.[39meventId)[33m.[39m[34mtoBe[39m([32m'test-attr-uuid-1234'[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m119| [39m        })[33m;[39m
    [90m120| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/attributionService.test.js[2m > [22mAttributionService[2m > [22mgetOrganizationAttribution[2m > [22mshould return all attribution events for org
[31m[1mAssertionError[22m: expected [] to have a length of 2 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 2[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/unit/backend/attributionService.test.js:[2m158:28[22m[39m
    [90m156| [39m
    [90m157| [39m            const result = await AttributionService.getOrganizationAttâ€¦
    [90m158| [39m            [34mexpect[39m(result)[33m.[39m[34mtoHaveLength[39m([34m2[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m159| [39m            [34mexpect[39m(result[[34m0[39m][33m.[39msourceType)[33m.[39m[34mtoBe[39m([32m'DEMO'[39m)[33m;[39m
    [90m160| [39m            [34mexpect[39m(result[[34m1[39m][33m.[39msourceType)[33m.[39m[34mtoBe[39m([32m'PROMO_CODE'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/attributionService.test.js[2m > [22mAttributionService[2m > [22mgetFirstAttribution[2m > [22mshould return first attribution event
[31m[1mTypeError[22m: Cannot read properties of null (reading 'sourceType')[39m
[36m [2mâ¯[22m tests/unit/backend/attributionService.test.js:[2m193:27[22m[39m
    [90m191| [39m
    [90m192| [39m            const result = await AttributionService.getFirstAttributioâ€¦
    [90m193| [39m            [34mexpect[39m(result[33m.[39msourceType)[33m.[39m[34mtoBe[39m([32m'DEMO'[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m194| [39m            [34mexpect[39m(result[33m.[39mcampaign)[33m.[39m[34mtoBe[39m([32m'launch'[39m)[33m;[39m
    [90m195| [39m            [34mexpect[39m(result[33m.[39mmedium)[33m.[39m[34mtoBe[39m([32m'organic'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/attributionService.test.js[2m > [22mAttributionService[2m > [22mhasAttribution[2m > [22mshould return true if org has attribution
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/unit/backend/attributionService.test.js:[2m215:28[22m[39m
    [90m213| [39m
    [90m214| [39m            const result = await AttributionService.hasAttribution('orâ€¦
    [90m215| [39m            [34mexpect[39m(result)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m216| [39m        })[33m;[39m
    [90m217| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/attributionService.test.js[2m > [22mAttributionService[2m > [22mexportAttribution[2m > [22mshould export with filters
[31m[1mAssertionError[22m: expected [] to have a length of 1 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 1[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/unit/backend/attributionService.test.js:[2m256:28[22m[39m
    [90m254| [39m            })[33m;[39m
    [90m255| [39m
    [90m256| [39m            [34mexpect[39m(result)[33m.[39m[34mtoHaveLength[39m([34m1[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m257| [39m            [34mexpect[39m(result[[34m0[39m][33m.[39morganizationName)[33m.[39m[34mtoBe[39m([32m'Test Org'[39m)[33m;[39m
    [90m258| [39m            [34mexpect[39m(result[[34m0[39m][33m.[39mpartnerCode)[33m.[39m[34mtoBe[39m([32m'PARTNER001'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/attributionService.test.js[2m > [22mAttributionService[2m > [22mgetPartnerSummary[2m > [22mshould return partner summary for settlements
[31m[1mAssertionError[22m: expected [] to have a length of 2 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 2[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/unit/backend/attributionService.test.js:[2m293:28[22m[39m
    [90m291| [39m
    [90m292| [39m            const result = await AttributionService.getPartnerSummary(â€¦
    [90m293| [39m            [34mexpect[39m(result)[33m.[39m[34mtoHaveLength[39m([34m2[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m294| [39m            [34mexpect[39m(result[[34m0[39m][33m.[39mpartnerCode)[33m.[39m[34mtoBe[39m([32m'PARTNER001'[39m)[33m;[39m
    [90m295| [39m            [34mexpect[39m(result[[34m0[39m][33m.[39morganizationCount)[33m.[39m[34mtoBe[39m([34m5[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mvalidatePromoCode[2m > [22mshould return invalid when code not found
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m71:13[22m[39m
    [90m 69| [39m
    [90m 70| [39m        [34mit[39m([32m'should return invalid when code not found'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m 71| [39m            db[33m.[39m[35mget[39m[33m.[39m[34mmockImplementation[39m((query[33m,[39m params[33m,[39m callback) [33m=>[39m {
    [90m   | [39m            [31m^[39m
    [90m 72| [39m                [34mcallback[39m([35mnull[39m[33m,[39m [35mnull[39m)[33m;[39m
    [90m 73| [39m            })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mvalidatePromoCode[2m > [22mshould return invalid for expired code
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m81:13[22m[39m
    [90m 79| [39m        [34mit[39m([32m'should return invalid for expired code'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m 80| [39m            const pastDate = new Date(Date.now() - 86400000).toISOStriâ€¦
    [90m 81| [39m            db[33m.[39m[35mget[39m[33m.[39m[34mmockImplementation[39m((query[33m,[39m params[33m,[39m callback) [33m=>[39m {
    [90m   | [39m            [31m^[39m
    [90m 82| [39m                [34mcallback[39m([35mnull[39m[33m,[39m {
    [90m 83| [39m                    id[33m:[39m [32m'code-1'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mvalidatePromoCode[2m > [22mshould return invalid for code not yet active
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m101:13[22m[39m
    [90m 99| [39m        it('should return invalid for code not yet active', async () =â€¦
    [90m100| [39m            const futureDate = new Date(Date.now() + 86400000).toISOStâ€¦
    [90m101| [39m            db[33m.[39m[35mget[39m[33m.[39m[34mmockImplementation[39m((query[33m,[39m params[33m,[39m callback) [33m=>[39m {
    [90m   | [39m            [31m^[39m
    [90m102| [39m                [34mcallback[39m([35mnull[39m[33m,[39m {
    [90m103| [39m                    id[33m:[39m [32m'code-1'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mvalidatePromoCode[2m > [22mshould return invalid when usage limit reached
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m120:13[22m[39m
    [90m118| [39m
    [90m119| [39m        it('should return invalid when usage limit reached', async () â€¦
    [90m120| [39m            db[33m.[39m[35mget[39m[33m.[39m[34mmockImplementation[39m((query[33m,[39m params[33m,[39m callback) [33m=>[39m {
    [90m   | [39m            [31m^[39m
    [90m121| [39m                [34mcallback[39m([35mnull[39m[33m,[39m {
    [90m122| [39m                    id[33m:[39m [32m'code-1'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mvalidatePromoCode[2m > [22mshould return valid for good code with discount
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m139:13[22m[39m
    [90m137| [39m
    [90m138| [39m        it('should return valid for good code with discount', async ()â€¦
    [90m139| [39m            db[33m.[39m[35mget[39m[33m.[39m[34mmockImplementation[39m((query[33m,[39m params[33m,[39m callback) [33m=>[39m {
    [90m   | [39m            [31m^[39m
    [90m140| [39m                [34mcallback[39m([35mnull[39m[33m,[39m {
    [90m141| [39m                    id[33m:[39m [32m'code-1'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mvalidatePromoCode[2m > [22mshould return valid for partner code without discount
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m165:13[22m[39m
    [90m163| [39m
    [90m164| [39m        it('should return valid for partner code without discount', asâ€¦
    [90m165| [39m            db[33m.[39m[35mget[39m[33m.[39m[34mmockImplementation[39m((query[33m,[39m params[33m,[39m callback) [33m=>[39m {
    [90m   | [39m            [31m^[39m
    [90m166| [39m                [34mcallback[39m([35mnull[39m[33m,[39m {
    [90m167| [39m                    id[33m:[39m [32m'code-1'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mmarkPromoCodeUsed[2m > [22mshould return error for already used org code
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m193:13[22m[39m
    [90m191| [39m        it('should return error for already used org code', async () =â€¦
    [90m192| [39m            [90m// Mock validatePromoCode to return valid[39m
    [90m193| [39m            db[33m.[39m[35mget[39m[33m.[39m[34mmockImplementation[39m((query[33m,[39m params[33m,[39m callback) [33m=>[39m {
    [90m   | [39m            [31m^[39m
    [90m194| [39m                [90m// First call is for validation[39m
    [90m195| [39m                [35mif[39m (query[33m.[39m[34mincludes[39m([32m'promo_codes'[39m)) {

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[21/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mcreatePromoCode[2m > [22mshould create promo code successfully
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m244:13[22m[39m
    [90m242| [39m
    [90m243| [39m        [34mit[39m([32m'should create promo code successfully'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m244| [39m            db.run.mockImplementation(function (query, params, callbacâ€¦
    [90m   | [39m            [31m^[39m
    [90m245| [39m                callback[33m.[39m[34mcall[39m({ changes[33m:[39m [34m1[39m }[33m,[39m [35mnull[39m)[33m;[39m
    [90m246| [39m            })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mlistPromoCodes[2m > [22mshould return list of promo codes
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m264:13[22m[39m
    [90m262| [39m    [34mdescribe[39m([32m'listPromoCodes'[39m[33m,[39m () [33m=>[39m {
    [90m263| [39m        [34mit[39m([32m'should return list of promo codes'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m264| [39m            db[33m.[39mall[33m.[39m[34mmockImplementation[39m((query[33m,[39m params[33m,[39m callback) [33m=>[39m {
    [90m   | [39m            [31m^[39m
    [90m265| [39m                [34mcallback[39m([35mnull[39m[33m,[39m [
    [90m266| [39m                    {

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[23/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mdeactivatePromoCode[2m > [22mshould deactivate promo code
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m293:13[22m[39m
    [90m291| [39m    [34mdescribe[39m([32m'deactivatePromoCode'[39m[33m,[39m () [33m=>[39m {
    [90m292| [39m        [34mit[39m([32m'should deactivate promo code'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m293| [39m            db.run.mockImplementation(function (query, params, callbacâ€¦
    [90m   | [39m            [31m^[39m
    [90m294| [39m                callback[33m.[39m[34mcall[39m({ changes[33m:[39m [34m1[39m }[33m,[39m [35mnull[39m)[33m;[39m
    [90m295| [39m            })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[24/26]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/backend/promoCodeService.test.js[2m > [22mPromoCodeService[2m > [22mdeactivatePromoCode[2m > [22mshould return false if code not found
[31m[1mReferenceError[22m: db is not defined[39m
[36m [2mâ¯[22m tests/unit/backend/promoCodeService.test.js:[2m302:13[22m[39m
    [90m300| [39m
    [90m301| [39m        [34mit[39m([32m'should return false if code not found'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m302| [39m            db.run.mockImplementation(function (query, params, callbacâ€¦
    [90m   | [39m            [31m^[39m
    [90m303| [39m                callback[33m.[39m[34mcall[39m({ changes[33m:[39m [34m0[39m }[33m,[39m [35mnull[39m)[33m;[39m
    [90m304| [39m            })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[25/26]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m5 failed[39m[22m[2m | [22m[1m[32m51 passed[39m[22m[90m (56)[39m
[2m      Tests [22m [1m[31m25 failed[39m[22m[2m | [22m[1m[32m564 passed[39m[22m[2m | [22m[33m10 skipped[39m[90m (599)[39m
[2m   Start at [22m 22:27:11
[2m   Duration [22m 5.71s[2m (transform 960ms, setup 8.27s, import 2.40s, tests 5.70s, environment 57.42s)[22m

[90mstdout[2m | Statement.<anonymous> (/Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/server/database.sqlite.active.js:103:26)
[22m[39mProjects table created successfully (or already exists).

JUNIT report written to /Users/piotrwisniewski/Documents/Antygracity/DRD/consultify/junit.xml
